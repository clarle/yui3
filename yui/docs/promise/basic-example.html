<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Example: Wrapping async transactions with promises - YUI Library</title>

    <meta name="viewport" content="width=960" id="meta-viewport">
    <script>
    if (screen.width < 768) {
        document.getElementById('meta-viewport').setAttribute('content', 'width=768');
    }
    </script>

    
    
    





    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,700,400italic,700italic">

    <link rel="stylesheet" href="https://yui-s.yahooapis.com/3.9.0/build/cssgrids/cssgrids-min.css">


    <link rel="stylesheet" href="/combo/css-main-min.css">



    <link rel="stylesheet" href="/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="/css/docs-min.css">




<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
<meta http-equiv="X-XRDS-Location" content="/xrds.xml">

    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@yuilibrary">
    <meta name="twitter:creator" content="@yuilibrary">
    <meta name="twitter:url" content="http://yuilibrary.com/yui/docs/promise/basic-example.html">
    <meta name="twitter:title" content="Example: Wrapping async transactions with promises">
    <meta name="twitter:description" content="Wrapping async transactions with promises">
    

<link rel="shortcut icon" type="image/png" href="/img/favicon.png">




    

    <script>
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-29453705-2']);
    _gaq.push(['_trackPageview']);
    </script>



    

    
        <script>
        var YUI_config={"filter":"min","maxURLLength":1024,"root":"3.17.2/","groups":{"site":{"combine":true,"comboBase":"/combo/js?","root":"","modules":{"hoverable":{"path":"hoverable-min.js","requires":["event-hover","node-base","node-event-delegate"]},"search":{"path":"search-min.js","requires":["autocomplete","autocomplete-highlighters","node-pluginhost"]},"api-filter":{"path":"apidocs/api-filter-min.js","requires":["autocomplete-base","autocomplete-highlighters","autocomplete-sources"]},"api-list":{"path":"apidocs/api-list-min.js","requires":["api-filter","api-search","event-key","node-focusmanager","tabview"]},"api-search":{"path":"apidocs/api-search-min.js","requires":["autocomplete-base","autocomplete-highlighters","autocomplete-sources","escape"]}}}}};
        if (location.protocol.indexOf('https') > -1) {
            YUI_config.comboBase = 'https://yui-s.yahooapis.com/combo?';
            YUI_config.combine = true;
        }
        </script>
    

    
        <script src="https://yui-s.yahooapis.com/3.17.2/build/yui/yui-min.js"></script>
    


</head>
<body class="yui3-skin-sam">

<!--
<a href="/yuiconf/" class="yuiconf ribbon">
    <img src="/img/yuiconf/2013/ribbon.png" alt="YUIConf 2013" width="139" height="139">
</a>
-->

<div id="doc">
    <div id="hd" class="yui3-g"><header>
        <div class="content">
            <div class="yui3-u-3-4">
                <a href="/" rel="home"><div id="hd-logo" role="image" aria-label="YUI logo"></div></a>
                
                
            </div>

            <div class="yui3-u-1-4">
                <form id="main-search" class="search" action="http://search.yahoo.com/search"
        method="get" role="search">

    <input type="search" class="search-input" name="q"
            aria-label="Search docs and APIs"
            placeholder="Search docs and APIs">

    <input type="hidden" name="vs" value="yuilibrary.com">
    <input type="hidden" name="vs" value="yuiblog.com">
</form>

            </div>

            <div id="main-nav" class="yui3-u"><nav>
    <ul class="nav hoverable-group">
        
            <li class="nav-tab hoverable ">
                <a href="/">Home</a>
                
            </li>
        
            <li class="nav-tab hoverable ">
                <a href="/yui/quick-start/">Quick Start</a>
                
                    <ul class="nav-submenu">
                        
                            <li class="nav-child ">
                                
                                    <a href="/yui/configurator/">Configurator</a>
                                
                            </li>
                        
                            <li class="nav-child ">
                                
                                    <a href="/download/yui3/">Download YUI 3</a>
                                
                            </li>
                        
                    </ul>
                
            </li>
        
            <li class="nav-tab hoverable  nav-tab-active">
                <a href="/yui/docs/">Documentation</a>
                
                    <ul class="nav-submenu">
                        
                            <li class="nav-child ">
                                
                                    <a href="/yui/docs/guides/">User Guides</a>
                                
                            </li>
                        
                            <li class="nav-child ">
                                
                                    <a href="/yui/docs/examples/">Examples</a>
                                
                            </li>
                        
                            <li class="nav-child ">
                                
                                    <a href="/yui/docs/api/">API Docs</a>
                                
                            </li>
                        
                            <li class="nav-child ">
                                
                                    <a href="/yui/environments/">Environments</a>
                                
                            </li>
                        
                            <li class="nav-child ">
                                
                                    <a href="/yui/docs/tutorials/">Tutorials</a>
                                
                            </li>
                        
                            <li class="nav-child ">
                                
                                    <a href="/yui/docs/tutorials/faq/">FAQ</a>
                                
                            </li>
                        
                    </ul>
                
            </li>
        
            <li class="nav-tab hoverable nav-break">
                <a href="/community/">Community</a>
                
                    <ul class="nav-submenu">
                        
                            <li class="nav-child ">
                                
                                    <a href="/gallery/">Gallery</a>
                                
                            </li>
                        
                            <li class="nav-child ">
                                
                                    <a href="http://yuiblog.com/">Blog</a>
                                
                            </li>
                        
                            <li class="nav-child ">
                                
                                    <a href="/forum/">Forums</a>
                                
                            </li>
                        
                            <li class="nav-child ">
                                
                                    <a href="/theater/">YUI Theater</a>
                                
                            </li>
                        
                            <li class="nav-child ">
                                
                                    <a href="https://github.com/yui/yui3/wiki/Development-Schedule" target="_blank" title="External link">Calendar &#187;</a>
                                
                            </li>
                        
                    </ul>
                
            </li>
        
            <li class="nav-tab hoverable ">
                <a href="/contribute/">Contribute</a>
                
                    <ul class="nav-submenu">
                        
                            <li class="nav-child ">
                                
                                    <a href="https://github.com/yui/" target="_blank" title="External link">YUI on GitHub &#187;</a>
                                
                            </li>
                        
                            <li class="nav-child ">
                                
                                    <a href="/projects/yui3/newticket/">File a Ticket</a>
                                
                            </li>
                        
                            <li class="nav-child ">
                                
                                    <a href="/projects/yui3/report/">View Tickets</a>
                                
                            </li>
                        
                            <li class="nav-child ">
                                
                                    <a href="/projects/yui3/dashboard/">Dashboard</a>
                                
                            </li>
                        
                    </ul>
                
            </li>
        
            <li class="nav-tab hoverable ">
                <a href="/projects/">Other Projects</a>
                
                    <ul class="nav-submenu">
                        
                            <li class="nav-child ">
                                
                                    <a href="http://yui.github.com/shifter/" target="_blank" title="External link">Shifter &#187;</a>
                                
                            </li>
                        
                            <li class="nav-child ">
                                
                                    <a href="http://yui.github.com/yogi/" target="_blank" title="External link">Yogi &#187;</a>
                                
                            </li>
                        
                            <li class="nav-child ">
                                
                                    <a href="/projects/yui2/">YUI 2</a>
                                
                            </li>
                        
                            <li class="nav-child ">
                                
                                    <a href="http://yui.github.com/yuidoc/" target="_blank" title="External link">YUI Doc &#187;</a>
                                
                            </li>
                        
                            <li class="nav-child ">
                                
                                    <a href="/projects/yuitest/">YUI Test</a>
                                
                            </li>
                        
                            <li class="nav-child ">
                                
                                    <a href="/projects/yuilibrary/">YUI Website</a>
                                
                            </li>
                        
                            <li class="nav-child ">
                                
                                    <a href="http://yui.github.com/yuicompressor/" target="_blank" title="External link">YUI Compressor &#187;</a>
                                
                            </li>
                        
                            <li class="nav-child ">
                                
                                    <a href="http://github.com/yui/builder" target="_blank" title="External link">YUI Builder &#187;</a>
                                
                            </li>
                        
                            <li class="nav-child ">
                                
                                    <a href="/projects/phploader/">YUI PHP Loader</a>
                                
                            </li>
                        
                            <li class="nav-child ">
                                
                                    <a href="http://yui.github.com/gridbuilder/" target="_blank" title="External link">Grid Builder &#187;</a>
                                
                            </li>
                        
                            <li class="nav-child ">
                                
                                    <a href="http://yui.github.com/skinbuilder/" target="_blank" title="External link">Skin Builder &#187;</a>
                                
                            </li>
                        
                    </ul>
                
            </li>
        
    </ul>
</nav></div>

        </div>
    </header></div>

    <div id="bd" class="clearfix yui3-g">
        
    <div id="breadcrumbs" class="yui3-u-1">
        <ul class="breadcrumbs">
            
                <li class="crumb"><a href="/yui/docs/">YUI</a></li>
                
                    <li class="separator">&gt;</li>
                
            
                <li class="crumb"><a href="/yui/utilities/">Utilities</a></li>
                
                    <li class="separator">&gt;</li>
                
            
                <li class="crumb"><a href="/yui/docs/promise/">Promise</a></li>
                
                    <li class="separator">&gt;</li>
                
            
                <li class="crumb"><a href="/yui/docs/promise/basic-example.html">Example: Wrapping async transactions with promises</a></li>
                
            
        </ul>
    </div>


        
    
        <div class="project-version yui3-u">Version 3.17.2</div>
    



        

        
            
    


            




    



<div class="yui3-u-1">
    <div id="docs-hd" class="content">
        <h1>Example: Wrapping async transactions with promises</h1>

        
            <a href="#docs-toc" class="jump" tabindex="1">Jump to Table of Contents</a>
        
    </div>
</div>

<div class="yui3-u-3-4 print-max-width">
    <div id="docs-main" class="content">
        <style>
    #demo div {
        padding: 5px;
        margin: 2px;
    }
    .success {
        background: #BBE599;
    }
    .error {
        background: #ffc5c4;
    }
</style>

<script>
YUI.GlobalConfig = {
    modules: {
        'github-api-mock': {
            fullpath: '../assets/promise/github-api-mock.js',
            requires: [],
            condition: {
                trigger: 'jsonp',
                when: 'instead',
                test: function () {
                    return (window.location.search.match(/[?&]mock=([^&]+)/) || [])[1] === 'true';
                }
            }
        }
    }  
};
</script>


<div class="intro">
    <p>
        This example shows how to create a cache for the GitHub Contributors API that returns promises representing the values you fetched. In order to access the API we use the JSONP module.
    </p>
</div>

<div class="example yui3-skin-sam">
    <div id="demo"></div>
    <script>
YUI().use('node', 'jsonp', 'promise', 'escape', function (Y) {

// A cache for GitHub user data
var GitHub = (function () {

    var cache = {},
        githubURL = 'https://api.github.com/users/{user}?callback={callback}';

    function getUserURL(name) {
        return Y.Lang.sub(githubURL, {
            user: name
        });
    }

    // Fetches a URL, stores a promise in the cache and returns it
    function fetch(url) {
        var promise = new Y.Promise(function (fulfill, reject) {
            Y.jsonp(url, function (res) {
                var meta = res.meta,
                    data = res.data;

                // Check for a successful response, otherwise reject the
                // promise with the message returned by the GitHub API.
                if (meta.status >= 200 && meta.status < 300) {
                    fulfill(data);
                } else {
                    reject(new Error(data.message));
                }
            });

            // Add a timeout in case the URL is completely wrong
            // or GitHub is too busy
            setTimeout(function () {
                // Once a promise has been fulfilled or rejected it will never
                // change its state again, so we can safely call reject() after
                // some time. If it was already fulfilled or rejected, nothing will
                // happen
                reject(new Error('Timeout'));
            }, 10000);
        });

        // store the promise in the cache object
        cache[url] = promise;

        return promise;
    }

    return {
        getUser: function (name) {
            var url = getUserURL(name);

            if (cache[url]) {
                // If we have already stored the promise in the cache we just return it
                return cache[url];
            } else {
                // fetch() will make a JSONP request, cache the promise and return it
                return fetch(url);
            }
        }
    };
}());


var demo = Y.one('#demo'),
    SUCCESS_TEMPLATE = '<div class="success">Loaded {name}\'s data! ' +
                        '<a href="{link}">Link to profile</a></div>',
    FAILURE_TEMPLATE = '<div class="error">{message}</div>';

function renderUser(user) {
    demo.setHTML(Y.Lang.sub(SUCCESS_TEMPLATE, {
        // escape the values gotten from the GitHub API to avoid unexpected
        // HTML injection which could be an XSS vulnerability
        name: Y.Escape.html(user.login),
        link: Y.Escape.html(user.html_url)
    }));
}

function showError(err) {
    demo.setHTML(
        'Looks like the service might be down - would you like to <a href="?mock=true">try this example with mock data</a>?'
    );
}

GitHub.getUser('yui').then(renderUser, showError);

});
</script>

</div>

<h3 id="creating-a-cache">Creating a Cache</h3>

<p>
    A cache is an object that keeps track of which operations have already been performed, stores the results and returns the stored result if the operation was already performed. In this case, since we are fetching content with JSONP, the operations are asynchronous so we will store promises representing them.
</p>

<pre class="code prettyprint">&#x2F;&#x2F; We create a simple module with a private cache object
var GitHub = (function () {

    var cache = {};

    return {
        getUser: function (name) {
            &#x2F;&#x2F; This method will return a promise
        }
    };
}());</pre>


<p>
    Given a certain function that takes a user name and returns the corresponding GitHub API URL, then a method that caches the user data will simply check the private cache object or fetch the result.
</p>

<pre class="code prettyprint">getUser: function (name) {
    var url = getUserURL(name);

    if (cache[url]) {
        &#x2F;&#x2F; If we have already stored the promise in the cache we just return it
        return cache[url];
    } else {
        &#x2F;&#x2F; fetch() will make a JSONP request, cache the promise and return it
        return fetch(url);
    }
}</pre>


<h3 id="resolving-and-returning-promises">Resolving and Returning Promises</h3>

<p>Our <code>fetch()</code> function will create a promise and fulfill it or reject it based on the result of the JSONP request. Following the steps described in the <a href="index.html##creating-a-promise">User Guide</a>, we create a promise and call <code>Y.jsonp</code> inside its initialization function.</p>

<pre class="code prettyprint">&#x2F;&#x2F; Fetches a URL, stores a promise in the cache and returns it
function fetch(url) {
    var promise = new Y.Promise(function (fulfill, reject) {
        Y.jsonp(url, function (res) {
            var meta = res.meta,
                data = res.data;

            &#x2F;&#x2F; Check for a successful response, otherwise reject the
            &#x2F;&#x2F; promise with the message returned by the GitHub API.
            if (meta.status &gt;= 200 &amp;&amp; meta.status &lt; 300) {
                fulfill(data);
            } else {
                reject(new Error(data.message));
            }
        });

        &#x2F;&#x2F; Add a timeout in case the URL is completely wrong
        &#x2F;&#x2F; or GitHub is too busy
        setTimeout(function () {
            &#x2F;&#x2F; Once a promise has been fulfilled or rejected it will never
            &#x2F;&#x2F; change its state again, so we can safely call reject() after
            &#x2F;&#x2F; some time. If it was already fulfilled or rejected, nothing will
            &#x2F;&#x2F; happen
            reject(new Error(&#x27;Timeout&#x27;));
        }, 10000);
    });

    &#x2F;&#x2F; store the promise in the cache object
    cache[url] = promise;

    return promise;
}</pre>


<h3 id="wiring-it-all-together">Wiring It All Together</h3>

<p>Here is the complete code for this example. You will notice that it contains a request for a user called "y u i" which likely does not exist. This illustrates how promises help you handle errors. While it may be tempting to skip adding an error callback, it is highly recommended that you add one and provide feedback to your users when things go wrong.</p>
<h4 id="html">HTML</h4>
<pre class="code prettyprint">&lt;div id=&quot;demo&quot;&gt;&lt;&#x2F;div&gt;</pre>


<h4 id="css">CSS</h4>
<pre class="code prettyprint">&lt;style&gt;
    #demo div {
        padding: 5px;
        margin: 2px;
    }
    .success {
        background: #BBE599;
    }
    .error {
        background: #ffc5c4;
    }
&lt;&#x2F;style&gt;</pre>


<h4 id="javascript">JavaScript</h4>
<pre class="code prettyprint">&lt;script&gt;
YUI().use(&#x27;node&#x27;, &#x27;jsonp&#x27;, &#x27;promise&#x27;, &#x27;escape&#x27;, function (Y) {

&#x2F;&#x2F; A cache for GitHub user data
var GitHub = (function () {

    var cache = {},
        githubURL = &#x27;https:&#x2F;&#x2F;api.github.com&#x2F;users&#x2F;{user}?callback={callback}&#x27;;

    function getUserURL(name) {
        return Y.Lang.sub(githubURL, {
            user: name
        });
    }

    &#x2F;&#x2F; Fetches a URL, stores a promise in the cache and returns it
    function fetch(url) {
        var promise = new Y.Promise(function (fulfill, reject) {
            Y.jsonp(url, function (res) {
                var meta = res.meta,
                    data = res.data;

                &#x2F;&#x2F; Check for a successful response, otherwise reject the
                &#x2F;&#x2F; promise with the message returned by the GitHub API.
                if (meta.status &gt;= 200 &amp;&amp; meta.status &lt; 300) {
                    fulfill(data);
                } else {
                    reject(new Error(data.message));
                }
            });

            &#x2F;&#x2F; Add a timeout in case the URL is completely wrong
            &#x2F;&#x2F; or GitHub is too busy
            setTimeout(function () {
                &#x2F;&#x2F; Once a promise has been fulfilled or rejected it will never
                &#x2F;&#x2F; change its state again, so we can safely call reject() after
                &#x2F;&#x2F; some time. If it was already fulfilled or rejected, nothing will
                &#x2F;&#x2F; happen
                reject(new Error(&#x27;Timeout&#x27;));
            }, 10000);
        });

        &#x2F;&#x2F; store the promise in the cache object
        cache[url] = promise;

        return promise;
    }

    return {
        getUser: function (name) {
            var url = getUserURL(name);

            if (cache[url]) {
                &#x2F;&#x2F; If we have already stored the promise in the cache we just return it
                return cache[url];
            } else {
                &#x2F;&#x2F; fetch() will make a JSONP request, cache the promise and return it
                return fetch(url);
            }
        }
    };
}());


var demo = Y.one(&#x27;#demo&#x27;),
    SUCCESS_TEMPLATE = &#x27;&lt;div class=&quot;success&quot;&gt;Loaded {name}\&#x27;s data! &#x27; +
                        &#x27;&lt;a href=&quot;{link}&quot;&gt;Link to profile&lt;&#x2F;a&gt;&lt;&#x2F;div&gt;&#x27;,
    FAILURE_TEMPLATE = &#x27;&lt;div class=&quot;error&quot;&gt;{message}&lt;&#x2F;div&gt;&#x27;;

function renderUser(user) {
    demo.setHTML(Y.Lang.sub(SUCCESS_TEMPLATE, {
        &#x2F;&#x2F; escape the values gotten from the GitHub API to avoid unexpected
        &#x2F;&#x2F; HTML injection which could be an XSS vulnerability
        name: Y.Escape.html(user.login),
        link: Y.Escape.html(user.html_url)
    }));
}

function showError(err) {
    demo.setHTML(
        &#x27;Looks like the service might be down - would you like to &lt;a href=&quot;?mock=true&quot;&gt;try this example with mock data&lt;&#x2F;a&gt;?&#x27;
    );
}

GitHub.getUser(&#x27;yui&#x27;).then(renderUser, showError);

});
&lt;&#x2F;script&gt;</pre>


    </div>
</div>

<div class="yui3-u-1-4">
    <div id="docs-sidebar" class="sidebar">
        
            
        

        
            <div id="docs-toc" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Table of Contents</h2>
                </div>

                <div class="bd">
                    <ul class="toc">
<li>
<a href="#creating-a-cache">Creating a Cache</a>
</li>
<li>
<a href="#resolving-and-returning-promises">Resolving and Returning Promises</a>
</li>
<li>
<a href="#wiring-it-all-together">Wiring It All Together</a>
<ul class="toc">
<li>
<a href="#html">HTML</a>
</li>
<li>
<a href="#css">CSS</a>
</li>
<li>
<a href="#javascript">JavaScript</a>
</li>
</ul>
</li>
</ul>
                </div>
            </div>
        

        
            
                <div class="sidebox">
                    <div class="hd">
                        <h2 class="no-toc">Examples</h2>
                    </div>

                    <div class="bd">
                        <ul class="examples">
                            
                                
                                    <li data-description="Wrapping async transactions with promises">
                                        <a href="basic-example.html">Wrapping async transactions with promises</a>
                                    </li>
                                
                            
                                
                                    <li data-description="Extend Y.Promise to create classes that encapsulate standard transaction logic in descriptive method names">
                                        <a href="subclass-example.html">Subclassing Y.Promise</a>
                                    </li>
                                
                            
                                
                                    <li data-description="Extend the Promise class to create your own Node plugin that chains transitions">
                                        <a href="plugin-example.html">Creating a Node Plugin that chains transitions</a>
                                    </li>
                                
                            
                        </ul>
                    </div>
                </div>
            
        

        
    </div>
</div>




        
    </div>

    <div id="ft"><footer>
        <p class="copyright">
        All code on this site is licensed under the <a href="/license/">BSD License</a> unless stated otherwise.<br>
        <span class="links"><a href="/about/">About This Site</a> &middot; <a href="/security/">Security Contact Info</a></span>
        </p>
    </footer></div>
</div>






    <script src="/combo/js-search-min.js-hoverable-min.js-main-min.js"></script>



    <script src="/vendor/prettify/prettify-min.js"></script>
    <script>prettyPrint();</script>



    <script>
    (function() {
        var ga = document.createElement('script'); ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    }());

    (function() {
        var ya = document.createElement('script'); ya.async = true;
        ya.src = ('https:' == document.location.protocol ? 'https://s' : 'http://d') + '.yimg.com/mi/ywa.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ya, s);

        window.onload = function () {
            try {
                var YWATracker = YWA.getTracker("10001393677061", "US");
                YWATracker.submit();
            } catch (eYWATCUnavailable) {
                if (window.console && window.console.warn) {
                    window.console.warn(eYWATCUnavailable.message || "Unknown error");
                }
            }
        };
    }());
    </script>




</body>
</html>
